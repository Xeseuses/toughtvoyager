{{ define "main" }}
<main style="padding: 2rem; max-width: 850px; margin: auto; font-family: 'Segoe UI', sans-serif; background: #fffdf7;">

<style>
  @media (prefers-color-scheme: dark) {
  main {
    background: #121212; /* very dark background */
    color: #ddd; /* light text */
  }
  .note-title {
    color: #a8d5a3; /* lighter green for title */
  }
  .post-meta {
    color: #aaa;
  }
  .content a[href^="/"] {
    color: #7fc77f;
  }
  .content a[href^="/"]:hover {
    color: #a8d5a3;
  }
  .related {
    background: #1e1e1e;
    border-left: 5px solid #3a663a;
  }
  .related h3 {
    color: #7fc77f;
  }
  .related a {
    color: #a8d5a3;
  }
  .related a:hover {
    text-decoration: underline;
  }
}

</style>


  <h1 class="note-title">{{ .Title }}</h1>
  <p class="post-meta">
    🗓️ Published: {{ .Date.Format "Jan 2, 2006" }}<br>
    🛠️ Last edited: {{ .Lastmod.Format "Jan 2, 2006" }}
  </p>

  {{/* Build title-to-page map */}}
  {{ $pageMap := dict }}
  {{ range .Site.RegularPages }}
    {{ $pageMap = merge $pageMap (dict .Title .) }}
  {{ end }}

  {{/* Replace wikilinks in already-rendered HTML (.Content) */}}
  {{ $pattern := `\[\[([^\[\]]+)\]\]` }}
  {{ $content := .Content }}

  {{ range $match := findRESubmatch $pattern $content }}
    {{ $linkText := index $match 1 }}
    {{ $page := index $pageMap $linkText }}
    {{ if $page }}
      {{ $link := printf `<a href="%s">%s</a>` $page.RelPermalink $linkText }}
      {{ $content = replace $content (index $match 0) $link }}
    {{ else }}
      {{ $slug := urlize $linkText }}
      {{ $fallback := printf `<a href="/posts/%s/">%s</a>` $slug $linkText }}
      {{ $content = replace $content (index $match 0) $fallback }}
    {{ end }}
  {{ end }}

  <div class="content">
    {{ $content | safeHTML }}
  </div>

  {{/* Related Notes */}}
  {{ $current := . }}
  {{ $related := where .Site.RegularPages "Type" "posts" }}
  {{ $related = where $related "Params.tags" "intersect" .Params.tags }}
  {{ $related = where $related "Permalink" "ne" $current.Permalink }}

  {{ if gt (len $related) 0 }}
    <div class="related">
      <h3>🔗 Related Notes</h3>
      <ul>
        {{ range $rel := $related }}
          <li><a href="{{ $rel.RelPermalink }}">{{ $rel.Title }}</a></li>
        {{ end }}
      </ul>
    </div>
  {{ end }}
  
  {{ partial "comments.html" . }}

</main>
{{ end }}

