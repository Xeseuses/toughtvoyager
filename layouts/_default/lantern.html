{{ define "main" }}
<main style="padding: 2rem; max-width: 850px; margin: auto; font-family: 'Segoe UI', sans-serif; background: #fffdf7;">

  {{/* Include Lantern CSS, minified & fingerprinted */}}
  {{ $css := resources.Get "css/lantern.css" | resources.Minify | resources.Fingerprint }}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}">

  <h1 class="note-title">{{ .Title }}</h1>
  <p class="post-meta">
    ğŸ—“ï¸ Published: {{ .Date.Format "Jan 2, 2006" }}<br>
    ğŸ› ï¸ Last edited: {{ .Lastmod.Format "Jan 2, 2006" }}
  </p>

  {{/* Build title-to-page map for wikilinks */}}
  {{ $pageMap := dict }}
  {{ range .Site.RegularPages }}
    {{ $pageMap = merge $pageMap (dict .Title .) }}
  {{ end }}

  {{/* Replace wikilinks ([[title]]) in already-rendered HTML (.Content) */}}
  {{ $pattern := `\[\[([^\[\]]+)\]\]` }}
  {{ $content := .Content }}

  {{ range $match := findRESubmatch $pattern $content }}
    {{ $linkText := index $match 1 }}
    {{ $page := index $pageMap $linkText }}
    {{ if $page }}
      {{ $link := printf `<a href="%s">%s</a>` $page.RelPermalink $linkText }}
      {{ $content = replace $content (index $match 0) $link }}
    {{ else }}
      {{ $slug := urlize $linkText }}
      {{ $fallback := printf `<a href="/posts/%s/">%s</a>` $slug $linkText }}
      {{ $content = replace $content (index $match 0) $fallback }}
    {{ end }}
  {{ end }}

  <div class="content">
    {{ $content | safeHTML }}
  </div>

  {{/* Trail navigation: previous / next */}}
  <nav class="trail-navigation" style="margin-top: 3rem; display:flex; justify-content: space-between; font-weight: 600;">
    {{ $pages := .Site.RegularPages.ByWeight }}
    {{ $current := . }}
    {{ $currentIndex := -1 }}
    {{ range $index, $page := $pages }}
      {{ if eq $page.Permalink $current.Permalink }}
        {{ $currentIndex = $index }}
      {{ end }}
    {{ end }}

    {{ $prev := slice }}
    {{ $next := slice }}
    {{ if ge $currentIndex 1 }}
      {{ $prev = index $pages (sub $currentIndex 1) }}
    {{ end }}
    {{ if lt (add $currentIndex 1) (len $pages) }}
      {{ $next = index $pages (add $currentIndex 1) }}
    {{ end }}

    {{ if $prev }}
      <a href="{{ $prev.RelPermalink }}" style="text-decoration:none;">â† {{ $prev.Title }}</a>
    {{ else }}
      <span></span>
    {{ end }}

    {{ if $next }}
      <a href="{{ $next.RelPermalink }}" style="text-decoration:none;">{{ $next.Title }} â†’</a>
    {{ else }}
      <span></span>
    {{ end }}
  </nav>

  {{/* Related Notes section */}}
  {{ $current := . }}
  {{ $related := where .Site.RegularPages "Type" "posts" }}
  {{ $related = where $related "Params.tags" "intersect" .Params.tags }}
  {{ $related = where $related "Permalink" "ne" $current.Permalink }}

  {{ if gt (len $related) 0 }}
    <div class="related">
      <h3>ğŸ”— Related Notes</h3>
      <ul>
        {{ range $rel := $related }}
          <li><a href="{{ $rel.RelPermalink }}">{{ $rel.Title }}</a></li>
        {{ end }}
      </ul>
    </div>
  {{ end }}

  {{ partial "comments.html" . }}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const trailSteps = document.querySelectorAll('.trail-step');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const index = Array.from(trailSteps).indexOf(entry.target);
            setTimeout(() => {
              entry.target.classList.add('visible');
            }, index * 150);  // stagger fade-in delay per step
          }
        });
      }, { threshold: 0.1 });

      trailSteps.forEach(step => observer.observe(step));
    });
  </script>

</main>
{{ end }}

